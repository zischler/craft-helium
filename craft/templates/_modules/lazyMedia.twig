<div class="o-lazy-media o-component">
    {% set asset = module.media.one() %}

    {% set thumb = {
        mode: 'crop',
        width: 100,
        height: 100,
        quality: 75,
        position: 'center-center'
    } %}

    {#-- rendition --#}
    {% set maxRenditionWidth = 2560 %}
    {#-- for ratio --#}
    {% set ratioW = 2560 %}
    {% set ratioH = 1920 %}
    {#-- for placeholder --#}
    {% set imageWidth = 2560 %}
    {% set imageHeight = 1920 %}
    {% set objectfit = "contain" %}
    {% set hasRatio = false %}
    {% set cssRatio = "" %}
    {% set assetRatio = "" %}
    {% set isInstantly = false %}
    {% set parameters = parameters ?? {} %}
    {#-- hasCaption --#}
    {% set hasCaption = false %}
    {% set asHero = asHero ?? false %}

    {% if asset != null %}

        {% if asset.kind == 'image' %}
            {% set imageWidth = asset.width %}
            {% set imageHeight = asset.height %}
            {% if imageWidth != 0 and imageHeight != 0 %}
                {% set assetRatioCss = "calc(" ~ imageHeight ~ " / " ~ imageWidth ~ " * 100%)" %}
            {% endif %}
        {% endif %}

        {#-- Params: assetRatio width W + H inputs --#}
        {% if parameters.width is defined and parameters.height is defined %}
            {% set hasRatio = true %}
            {% set ratioW = parameters.width %}
            {% set ratioH = parameters.height %}
        {% endif %}

        {#-- Params : assetRatio Selection --#}
        {% if parameters.assetRatio is defined %}
            {% set assetRatio = parameters.assetRatio ?? null %}
        {% endif %}

        {#-- Inherited Params : from Carousel --#}
        {% if parameters.itemRatio is defined %}
            {% set assetRatio = parameters.itemRatio ?? null%}
        {% endif %}

        {% if assetRatio != null%}
            {% set hasRatio = true%}
            {% set ratioArray = assetRatio | split("/") %}
            {% if ratioArray != null and ratioArray?size == 2%}
                {% set ratioW = ratioArray[0] ?? null%}
                {% set ratioH = ratioArray[1] ?? null%}
            {% endif %}
        {% endif %}

        {#-- isCover --#}
        {% set isCover = (parameters.isCover is defined and parameters.isCover == true) and (hasRatio is defined and hasRatio == true) %}

        {#-- asHero --#}
        {% set asHero = (parameters.asHero is defined and parameters.asHero == true) %}
        {% set isCover = asHero %}

        {#-- maxRendition --#}
        {% if parameters.maxRenditionWidth is defined %}
            {% set maxRenditionWidth = def.parameters.maxRenditionWidth?number%}
        {% elseif imageWidth != null and imageWidth != 2560 %}
            {% set maxRenditionWidth = imageWidth %}
        {% endif %}

        {#-- objectfit --#}
        {% if isCover != null and isCover == true %}
            {% set objectfit = "cover" %}
        {% else %}
            {% set objectfit = "contain" %}
        {% endif %}

        {#-- max Dimensions --#}
        {% set hasMaxSize = false %}
        {% set maxWidth = "100%" %}
        {% set maxHeight = "unset" %}

        {% if not isCover%}
            {% if parameters.maxWidth is defined %}
                {% set maxWidth = parameters.maxWidth %}
                {% set hasMaxSize = true %}
            {% endif %}

            {% if parameters.maxHeight is defined %}
                {% set maxHeight = parameters.maxHeight %}
                {% set hasMaxSize = true %}
            {% endif %}
        {% endif %}

        {% set positionClass = "is-center"%}
        {% if position is defined %}
            {% set positionClass = "is-" + position%}
        {% endif %}

        {% set ratioObj = '{}' %}
        {% set cssRatioObj = '{}' %}

        {% if asHero == true %}
            {% if hasRatio != false %}
                {% set ratioObj = "{w:" + ratioW + ",h:" + ratioH + "}" %}
                {% set cssRatioObj = "calc(" + ratioH + " / " + ratioW + " * 100%)" %}
                {% set assetRatioCss = cssRatioObj %}
            {% endif %}
        {% endif %}

        {% set dataJson = "" %}
        {% include "_includes/mediaJSON.twig" %}

        {#-- Asset Rendering --#}
        <lazy-media :ratio="{{ ratioObj ?? '' }}"
                    :css-ratio="'{{ cssRatioObj ?? '' }}'"
                    :position-class="'{{ positionClass ?? '' }}'"
                    :data-json="'{{ dataJson ?? '' }}'"
                    :as-hero="{{ asHero ?? '' }}"
                    :is-cover="{{ isCover ?? '' }}"
                    :has-ratio="{{ hasRatio ?? '' }}"
                    :has-caption="{{ hasCaption ?? '' }}"
                    :max-rendition="{{ maxRenditionWidth ?? '' }}"
                    :max-width="{{ maxWidth ?? '' }}"
                    :max-height="{{ maxHeight ?? '' }}"
                    :natural-height="{{ imageHeight ?? '' }}"
                    :natural-width="{{ imageWidth ?? '' }}"
            >
            <figure class="figure" {% if assetRatioCss is defined %}style="padding-top: {{ assetRatioCss ?? '' }}; font-size: 0;"{% endif %}>
                {% if asset.kind == 'image' %}
                    <picture class="container js-loaded {% if assetRatioCss != null%}has-fixed-ratio{% endif %}">
                        <img class="media {{ positionClass ? ''}} is-{{ objectfit ? ''}}" width="{{ imageWidth ? ''}}" height="{{ imageHeight ? ''}}"
                             src="{% if assetRatioCss is defined %}data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII={% else %}{{ asset.getUrl(thumb) }}{% endif %}" style="display: block; max-width: {{ maxWidth ?? '' }} ; max-height: {{ maxHeight ?? '' }} ;{% if hasRatio == null %} opacity: 0;{% endif %}" {% if assetMap is defined %}{# TODO: Add alt macro stuff #}{% endif %}>
                    </picture>
                {% else %}
                    <video controls class="container media js-loaded {% if assetRatioCss != null%}has-fixed-ratio{% endif %}" src="" preload="metadata" style="display: block; max-width:{{ maxWidth ?? '' }}; max-height:{{ maxHeight ?? '' }}; visibility: hidden;">
                    </video>
                {% endif %}
            </figure>
        </lazy-media>
        {% if hasCaption == true%}
            <div class="caption">{{ asset.caption ?? ''}}</div>
        {% endif %}
    {% endif %}

</div>
